name: Trading Bot Rebalancing

on:
  schedule:
    # Run every Monday at 00:00 UTC
    # Format: minute hour day month day-of-week
    # Adjust the time as needed (times are in UTC)
    - cron: '0 0 * * 1'
  workflow_dispatch:  # Allows manual triggering from GitHub UI

jobs:
  rebalance:
    runs-on: ubuntu-latest
    timeout-minutes: 10  # Adjust based on your needs
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Run trading bot
        env:
          # Leaderboard API (use secrets for sensitive data)
          LEADERBOARD_API_URL: ${{ secrets.LEADERBOARD_API_URL }}
          LEADERBOARD_API_TOKEN: ${{ secrets.LEADERBOARD_API_TOKEN }}
          
          # Broker Configuration
          # Use vars for non-sensitive config, secrets for sensitive data
          BROKER_TYPE: ${{ vars.BROKER_TYPE }}
          ALPACA_API_KEY: ${{ secrets.ALPACA_API_KEY }}
          ALPACA_API_SECRET: ${{ secrets.ALPACA_API_SECRET }}
          ALPACA_BASE_URL: ${{ vars.ALPACA_BASE_URL }}
          
          # Trading Configuration (non-sensitive, use vars)
          INITIAL_CAPITAL: ${{ vars.INITIAL_CAPITAL }}
          SCHEDULER_MODE: external  # Required for GitHub Actions
          
          # Email Configuration (optional)
          EMAIL_ENABLED: ${{ vars.EMAIL_ENABLED }}
          EMAIL_RECIPIENT: ${{ secrets.EMAIL_RECIPIENT }}
          EMAIL_PROVIDER: ${{ vars.EMAIL_PROVIDER }}
          SMTP_HOST: ${{ vars.SMTP_HOST }}
          SMTP_PORT: ${{ vars.SMTP_PORT }}
          SMTP_USERNAME: ${{ secrets.SMTP_USERNAME }}
          SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
          SMTP_FROM_EMAIL: ${{ secrets.SMTP_FROM_EMAIL }}
        run: |
          # Run bot in one-shot mode (external scheduler)
          python -c "
          from src.main import TradingBot
          bot = TradingBot()
          bot.initialize()
          bot._execute_rebalancing()
          "
      
      - name: Upload logs (if job fails)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: error-logs
          path: |
            *.log
            logs/
          if-no-files-found: ignore
