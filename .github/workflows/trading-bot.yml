name: Trading Bot Rebalancing

on:
  schedule:
    # Run every Monday at 9:30 AM Eastern Time (market open) - timezone-aware
    # Format: minute hour day month day-of-week
    # Schedule at both possible UTC times; code will verify correct ET time
    # 9:30 AM EDT = 13:30 UTC (March-November, Daylight Saving Time)
    # 9:30 AM EST = 14:30 UTC (November-March, Standard Time)
    - cron: '30 13 * * 1'  # EDT period
    - cron: '30 14 * * 1'  # EST period
  workflow_dispatch:  # Allows manual triggering from GitHub UI
    inputs:
      force_run:
        description: 'Execute trades (true) or dry-run (false)'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

jobs:
  rebalance:
    runs-on: ubuntu-latest
    timeout-minutes: 10  # Adjust based on your needs
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Run trading bot
        env:
          # Leaderboard API (use secrets for sensitive data)
          LEADERBOARD_API_URL: ${{ secrets.LEADERBOARD_API_URL }}
          LEADERBOARD_API_TOKEN: ${{ secrets.LEADERBOARD_API_TOKEN }}
          
          # Broker Configuration
          # Use vars for non-sensitive config, secrets for sensitive data
          BROKER_TYPE: ${{ vars.BROKER_TYPE }}
          ALPACA_API_KEY: ${{ secrets.ALPACA_API_KEY }}
          ALPACA_API_SECRET: ${{ secrets.ALPACA_API_SECRET }}
          ALPACA_BASE_URL: ${{ vars.ALPACA_BASE_URL }}
          
          # Trading Configuration (non-sensitive, use vars)
          INITIAL_CAPITAL: ${{ vars.INITIAL_CAPITAL }}
          SCHEDULER_MODE: external  # Required for GitHub Actions
          
          # Execution Control
          # For manual triggers: use input value (defaults to 'false' = dry-run)
          #   Can override with vars.FORCE_RUN if input not explicitly set
          # For scheduled runs: always execute (FORCE_RUN not checked, but can be set for consistency)
          FORCE_RUN: ${{ github.event_name == 'workflow_dispatch' && inputs.force_run || vars.FORCE_RUN || 'false' }}
          
          # Email Configuration (optional)
          EMAIL_ENABLED: ${{ vars.EMAIL_ENABLED }}
          EMAIL_RECIPIENT: ${{ secrets.EMAIL_RECIPIENT }}
          EMAIL_PROVIDER: ${{ vars.EMAIL_PROVIDER }}
          SMTP_HOST: ${{ vars.SMTP_HOST }}
          SMTP_PORT: ${{ vars.SMTP_PORT }}
          SMTP_USERNAME: ${{ secrets.SMTP_USERNAME }}
          SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
          SMTP_FROM_EMAIL: ${{ secrets.SMTP_FROM_EMAIL }}
        run: |
          # Run bot in one-shot mode (external scheduler)
          python -c "
          from src.main import TradingBot
          bot = TradingBot()
          bot.initialize()
          bot._execute_rebalancing()
          "
      
      - name: Upload logs (if job fails)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: error-logs
          path: |
            *.log
            logs/
          if-no-files-found: ignore
