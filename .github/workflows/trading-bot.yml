name: Trading Bot Rebalancing

on:
  schedule:
    # Run every 5 minutes from 9:30-10:00 AM Eastern Time on Monday
    # This enables cron resilience - if a run fails, the next one will retry
    # Code will check submitted trades and early exit if already successful

    # EDT period (March-November): 9:30 AM = 13:30 UTC
    - cron: '30 13 * * 1'   # 9:30 AM EDT
    - cron: '35 13 * * 1'   # 9:35 AM EDT
    - cron: '40 13 * * 1'   # 9:40 AM EDT
    - cron: '45 13 * * 1'   # 9:45 AM EDT
    - cron: '50 13 * * 1'   # 9:50 AM EDT
    - cron: '55 13 * * 1'   # 9:55 AM EDT
    - cron: '0 14 * * 1'    # 10:00 AM EDT

    # EST period (November-March): 9:30 AM = 14:30 UTC
    - cron: '30 14 * * 1'   # 9:30 AM EST
    - cron: '35 14 * * 1'   # 9:35 AM EST
    - cron: '40 14 * * 1'   # 9:40 AM EST
    - cron: '45 14 * * 1'   # 9:45 AM EST
    - cron: '50 14 * * 1'   # 9:50 AM EST
    - cron: '55 14 * * 1'   # 9:55 AM EST
    - cron: '0 15 * * 1'    # 10:00 AM EST

  workflow_dispatch:  # Allows manual triggering from GitHub UI
    inputs:
      force_run:
        description: 'Execute trades (true) or dry-run (false)'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

jobs:
  rebalance:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run trading bot
        env:
          # Leaderboard API
          LEADERBOARD_API_URL: ${{ secrets.LEADERBOARD_API_URL }}
          LEADERBOARD_API_TOKEN: ${{ secrets.LEADERBOARD_API_TOKEN }}

          # Broker Configuration
          BROKER_TYPE: ${{ env.vars.BROKER_TYPE }}
          ALPACA_API_KEY: ${{ secrets.ALPACA_API_KEY }}
          ALPACA_API_SECRET: ${{ secrets.ALPACA_API_SECRET }}
          ALPACA_BASE_URL: ${{ vars.ALPACA_BASE_URL }}

          # Trading Configuration
          INITIAL_CAPITAL: ${{ vars.INITIAL_CAPITAL }}
          TRADE_INDICES: ${{ vars.TRADE_INDICES }}
          INITIAL_CAPITAL_SP400: ${{ vars.INITIAL_CAPITAL_SP400 }}
          INITIAL_CAPITAL_SP500: ${{ vars.INITIAL_CAPITAL_SP500 }}
          INITIAL_CAPITAL_SP600: ${{ vars.INITIAL_CAPITAL_SP600 }}
          INITIAL_CAPITAL_NDX: ${{ vars.INITIAL_CAPITAL_NDX }}
          SCHEDULER_MODE: external

          # Execution Control
          FORCE_RUN: ${{ github.event_name == 'workflow_dispatch' && inputs.force_run || vars.FORCE_RUN || 'false' }}

          # Email Configuration (optional)
          EMAIL_ENABLED: ${{ vars.EMAIL_ENABLED }}
          EMAIL_RECIPIENT: ${{ secrets.EMAIL_RECIPIENT }}
          EMAIL_PROVIDER: ${{ vars.EMAIL_PROVIDER }}
          SMTP_HOST: ${{ vars.SMTP_HOST }}
          SMTP_PORT: ${{ vars.SMTP_PORT }}
          SMTP_USERNAME: ${{ secrets.SMTP_USERNAME }}
          SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
          SMTP_FROM_EMAIL: ${{ secrets.SMTP_FROM_EMAIL }}

          # Persistence Configuration (optional)
          FIREBASE_PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID }}
          FIREBASE_CREDENTIALS_JSON: ${{ secrets.FIREBASE_CREDENTIALS_JSON }}
          PERSISTENCE_ENABLED: ${{ vars.PERSISTENCE_ENABLED }}
        run: |
          python -c "
          from src.main import TradingBot
          bot = TradingBot()
          bot.initialize()
          bot._execute_rebalancing()
          "

      - name: Upload logs (if job fails)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: error-logs
          path: |
            *.log
            logs/
          if-no-files-found: ignore
